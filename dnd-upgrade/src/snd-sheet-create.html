<link rel="import" href="../bower_components/polymer/polymer.html">
<link rel="import" href="../bower_components/paper-tabs/paper-tab.html">
<link rel="import" href="../bower_components/paper-tabs/paper-tabs.html">
<link rel="import" href="../bower_components/iron-pages/iron-pages.html">
<link rel="import" href="../bower_components/paper-fab/paper-fab.html">
<link rel="import" href="../bower_components/iron-icons/iron-icons.html">
<link rel="import" href="../bower_components/paper-dialog/paper-dialog.html">
<link rel="import" href="../bower_components/paper-button/paper-button.html">

<link rel="import" href="create-basic-tab.html">
<link rel="import" href="create-status-tab.html">
<link rel="import" href="create-resources-tab.html">
<link rel="import" href="create-defenses-tab.html">
<link rel="import" href="create-skills-tab.html">

<dom-module id="snd-sheet-create">

    <template>

        <style>
            :host {
                display: block;
            }

            paper-tabs {
                background-color: var(--primary-color);
                color: #FFF;
            }

            paper-fab {
                position: absolute;
                top: 56px;
                right: 16px;
            }

            iron-pages{
                height: calc(100vh - 50px - 64px);
                margin-top: 2px;
                overflow: auto;
            }
        </style>

        <paper-tabs noink
                    scrollable
                    hide-scroll-buttons
                    selected="{{ tabSelected }}">
            <paper-tab>Basic</paper-tab>
            <paper-tab>Status</paper-tab>
            <paper-tab>Resources</paper-tab>
            <paper-tab>Defenses</paper-tab>
            <paper-tab>Skills</paper-tab>
        </paper-tabs>

        <iron-pages selected="{{ tabSelected }}">

            <create-basic-tab name="{{ newSheet.name }}"
                              job="{{ newSheet.job }}"
                              race="{{ newSheet.race }}"
                              level="{{ newSheet.level }}"
                              system="{{ newSheet.system }}"></create-basic-tab>

            <create-status-tab status-list="{{ newSheet.statusList }}"></create-status-tab>

            <create-resources-tab resources-list="{{ newSheet.resourcesList }}"
                                  status-list="[[ newSheet.statusList ]]"></create-resources-tab>

            <create-defenses-tab defenses-list="{{ newSheet.defensesList }}"
                                 status-list="[[ newSheet.statusList ]]"></create-defenses-tab>

            <create-skills-tab skills-list="{{ newSheet.skillsList }}"
                               status-list="[[ newSheet.statusList ]]"></create-skills-tab>

        </iron-pages>

        <paper-fab icon="save"
                   on-click="_openSaveSheetDialog"></paper-fab>

        <paper-dialog opened="{{ dialogOpen }}">
            <h2>Save New Sheet</h2>
            <p>Do you want to save this new sheet? </p>
            <p>Keep in mind that you can't add or remove anything later.</p>
            <div class="buttons">
                <paper-button dialog-dismiss>Decline</paper-button>
                <paper-button dialog-confirm
                              autofocus
                              on-click="_saveSheet">Accept</paper-button>
            </div>
        </paper-dialog>

    </template>

    <script>

        Polymer({

            is: 'snd-sheet-create',

            properties: {
                tabSelected: {
                    type: String,
                    value: "0",
                    notify: true
                },
                newSheet: {
                    type: Object,
                    notify: true
                },
                baseSheet: {
                    type: Object,
                    notify: true
                },
                sheetList: {
                    type: Object,
                    notify: true
                }
            },

            attached: function(e){
                Polymer.updateStyles();
            },

            _openSaveSheetDialog: function(e){
                this.dialogOpen = !this.dialogOpen;
            },

            _saveSheet: function(e){
                // Need to Verify  Each Status, Resource, Defense and Skill and SUM
                var element = this;
                // SUM Status = baseValue + (levelModifier * level)
                this.newSheet.statusList.forEach(
                    function(status, index){
                        status.value = parseInt(status.baseValue) + (parseFloat(status.levelModifier) * parseInt(element.newSheet.level));
                    }
                );
                // SUM Resource = baseValue + (statusBase.value * statusBaseModifier) + (levelModifier * level)
                // or if statusBase == None => SUM Resource = baseValue + (levelModifier * level)
                this.newSheet.resourcesList.forEach(
                    function(resource, index){
                        if(resource.statusBase != "None"){
                            var baseStatusValue = Enumerable.From(element.newSheet.statusList)
                                                            .Where(function (x) { return x.name == resource.statusBase })
                                                            .Select(function (x) { return x.value })
                                                            .ToString();
                            resource.value = parseInt(parseInt(resource.baseValue) + (parseFloat(resource.statusBaseModifier) * parseInt(baseStatusValue)) + (parseFloat(resource.levelModifier) * parseInt(element.newSheet.level)));
                        } else{
                            resource.value = parseInt(parseInt(resource.baseValue) + (parseFloat(resource.levelModifier) * parseInt(element.newSheet.level)));
                        }
                    }
                );
                // SUM Defense = baseValue + (statusBase.value * statusBaseModifier) + (levelModifier * level)
                // or if statusBase == None => SUM Defense = baseValue + (levelModifier * level)
                this.newSheet.defensesList.forEach(
                    function(defense, index){
                        if(defense.statusBase != "None"){
                            var baseStatusValue = Enumerable.From(element.newSheet.statusList)
                                                            .Where(function (x) { return x.name == defense.statusBase })
                                                            .Select(function (x) { return x.value })
                                                            .ToString();
                            defense.value = parseInt(parseInt(defense.baseValue) + (parseFloat(defense.statusBaseModifier) * parseInt(baseStatusValue)) + (parseFloat(defense.levelModifier) * parseInt(element.newSheet.level)));
                        } else{
                            defense.value = parseInt(parseInt(defense.baseValue) + (parseFloat(defense.levelModifier) * parseInt(element.newSheet.level)));
                        }
                    }
                );
                // SUM Skill = baseValue + (statusBase.value * statusBaseModifier) + (levelModifier * level)
                // or if statusBase == None => SUM Skill = baseValue + (levelModifier * level)
                this.newSheet.skillsList.forEach(
                    function(skill, index){
                        if(skill.statusBase != "None"){
                            var baseStatusValue = Enumerable.From(element.newSheet.statusList)
                                                            .Where(function (x) { return x.name == skill.statusBase })
                                                            .Select(function (x) { return x.value })
                                                            .ToString();
                            skill.value = parseInt(parseInt(skill.baseValue) + (parseFloat(skill.statusBaseModifier) * parseInt(baseStatusValue)) + (parseFloat(skill.levelModifier) * parseInt(element.newSheet.level)));
                        } else{
                            skill.value = parseInt(parseInt(skill.baseValue) + (parseFloat(skill.levelModifier) * parseInt(element.newSheet.level)));
                        }
                    }
                );
                // Pushing to SheetList and Cleaning the newSheet
                this.push("sheetList.list", this.newSheet);
                this.set("newSheet", this.baseSheet);
                this.fire('requestChangeRoute', {
                    route: "/list"
                });
            }

        });

    </script>

</dom-module>
